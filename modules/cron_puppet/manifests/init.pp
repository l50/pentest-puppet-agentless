class cron_puppet {
  case $::osfamily {
    'Debian': {
      exec { "apt-update":
        command => "/usr/bin/apt-get update"
      }
    }
  } ->

  file { 'post-hook':
    ensure  => present,
    path    => '/etc/puppet/.git/hooks/post-merge',
    source  => 'puppet:///modules/cron_puppet/post-merge',
    mode    => '0755',
    owner   => root,
    group   => root,
  }

  file { 'puppet-logrotate':
    ensure => file,
    path   => '/etc/logrotate.d/puppet',
    source => 'puppet:///modules/cron_puppet/puppet.logrotate',
    mode   => '0644',
    owner  => 'root',
    group  => 'root',
  }

  # Run every 20 minutes
  cron { 'git-pull':
    ensure  => present,
    command => 'cd /etc/puppet ; /usr/bin/git pull',
    user    => 'root',
    minute  => '*/20',
    require => File['post-hook'],
  }

  # Run every 55th minute on the hour (e.g. 4:55, 5:55, etc.)
  cron { 'puppet-apply':
    ensure  => present,
    command => '/etc/puppet/.git/hooks/post-merge',
    user    => 'root',
    minute  => '55',
    require => File['post-hook'],
  }

  cron { 'puppet-apply-reboot':
    ensure  => present,
    command => '/etc/puppet/.git/hooks/post-merge',
    user    => 'root',
    special => 'reboot',
    require => File['post-hook'],
  }
}
