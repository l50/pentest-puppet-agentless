#!/bin/bash -e
PUPPET_DIRECTORY="/etc/puppet"

# Install Git and Puppet
apt-get update
apt-get -y install git-core openssl puppet

# Clone the 'puppet' repo
if [ -d "$PUPPET_DIRECTORY" ]; then
    mv /etc/puppet/ /etc/puppet-bak
fi

# Install Git and Puppet
git clone http://github.com/l50/puppet-pentest-agentless.git /etc/puppet

# Install librarian puppet for module management sanity
gem install librarian-puppet --no-ri --no-rdoc

# Install modules using librarian puppet
cd /etc/puppet && librarian-puppet install

# Run Puppet initially to set up the auto-deploy mechanism
puppet apply /etc/puppet/manifests/site.pp
