#!/bin/bash -e

## Install Git and Puppet
apt-get update
apt-get -y install git-core

# Clone the 'puppet' repo
cd /etc
if [ -d "$DIRECTORY" ]; then
  mv puppet/ puppet-bak
fi
git clone http://github.com/l50/puppet-pentest-agentless.git /etc/puppet

# Install librarian puppet for module management sanity
gem install librarian-puppet puppet:3.7.5 --no-ri --no-rdoc

# Install modules using librarian puppet
cd /etc/puppet && librarian-puppet install

# Run Puppet initially to set up the auto-deploy mechanism
puppet apply /etc/puppet/manifests/site.pp
