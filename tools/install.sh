#!/bin/bash -e
PUPPET_DIRECTORY="/etc/puppet"

if [[ `uname` != 'Darwin' ]]
then
  os=`cat /etc/os-release | perl -n -e'while(/^ID=(.*)/g) {print "$1\n"}'`
  # Install Git
  apt-get update
  apt-get -y install git-core openssl wget vim ruby
  # Install Puppet
  if [[ $os == 'kali' ]]
  then
    apt-get install -y puppet
  elif [[ $os == 'ubuntu' ]]
  then
    wget https://apt.puppetlabs.com/puppetlabs-release-pc1-xenial.deb
    dpkg -i puppetlabs-release-pc1-xenial.deb
    apt-get update
    apt-get -y install puppet-agent
    rm puppetlabs-release-pc1-xenial.deb
    ln -s /opt/puppetlabs/bin/puppet /usr/bin/puppet
  fi
else
  echo 'OS X detected, we have not added functionality yet.'
fi

# Make a backup if necessary
if [ -d "$PUPPET_DIRECTORY" ]; then
    mv /etc/puppet/ /etc/puppet-bak
fi

# Clone the project
git clone http://github.com/l50/puppet-pentest-agentless.git /etc/puppet

# Install librarian puppet for module management sanity
gem install librarian-puppet --no-ri --no-rdoc

# Install modules using librarian puppet
cd /etc/puppet && librarian-puppet install

# Run Puppet initially to set up the auto-deploy mechanism
/usr/bin/puppet apply /etc/puppet/manifests/site.pp --modulepath=/etc/puppet/modules
